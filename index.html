<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bowen Chat</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    #login-container, #chat-container {
      display: none;
      flex-direction: column;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 400px;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    button {
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      height: 300px;
      background: #fafafa;
    }

    .message {
      margin-bottom: 8px;
      background: #e9ecef;
      padding: 8px 10px;
      border-radius: 8px;
    }

    .message b {
      color: #007bff;
    }

    #chat-input {
      display: flex;
      gap: 10px;
    }

    #message-input {
      flex: 1;
    }

    #logout {
      background: #dc3545;
    }

    #logout:hover {
      background: #a71d2a;
    }

    .switch {
      text-align: center;
      margin-top: 10px;
      color: #007bff;
      cursor: pointer;
    }

    .switch:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

  <!-- LOGIN & REGISTRATIE -->
  <div id="login-container">
    <h2>Bowen Chat</h2>

    <form id="login-form">
      <input type="text" id="login-username" placeholder="Gebruikersnaam" required />
      <input type="password" id="login-password" placeholder="Wachtwoord" required />
      <button type="submit">Inloggen</button>
    </form>

    <form id="register-form" style="display:none;">
      <input type="text" id="register-username" placeholder="Kies een gebruikersnaam" required />
      <input type="password" id="register-password" placeholder="Kies een wachtwoord" required />
      <button type="submit">Registreren</button>
    </form>

    <div class="switch" id="toggle-form">Nog geen account? Registreer hier</div>
  </div>

  <!-- CHAT -->
  <div id="chat-container">
    <h2>Global Chat</h2>
    <div id="chat-messages"></div>

    <div id="chat-input">
      <input type="text" id="message-input" placeholder="Typ een bericht..." />
      <button id="send-message">Versturen</button>
    </div>

    <button id="logout">Uitloggen</button>
  </div>

  <script type="module">
    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAEgibIURvA8btzJvM2LVHsfBpw6oEnV1s",
      authDomain: "bowen-chat.firebaseapp.com",
      databaseURL: "https://bowen-chat-default-rtdb.firebaseio.com",
      projectId: "bowen-chat",
      storageBucket: "bowen-chat.firebasestorage.app",
      messagingSenderId: "376483632957",
      appId: "1:376483632957:web:ed9f25c3cc2f01a8701fa6"
    };
    firebase.initializeApp(firebaseConfig);

    // --- Cookie functies ---
    function setCookie(name, value, days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
    }

    function getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r;
      }, '');
    }

    function deleteCookie(name) {
      setCookie(name, '', -1);
    }

    // --- Elementen ---
    const loginContainer = document.getElementById('login-container');
    const chatContainer = document.getElementById('chat-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendMessageButton = document.getElementById('send-message');
    const logoutButton = document.getElementById('logout');
    const toggleForm = document.getElementById('toggle-form');

    let currentUser = null;

    // --- Wissel login/register ---
    toggleForm.addEventListener('click', () => {
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'flex';
        registerForm.style.display = 'none';
        toggleForm.textContent = 'Nog geen account? Registreer hier';
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'flex';
        toggleForm.textContent = 'Heb je al een account? Log hier in';
      }
    });

    // --- UI tonen/verbergen ---
    function showChatContainer() {
      loginContainer.style.display = 'none';
      chatContainer.style.display = 'flex';
      loadGlobalChat();
    }

    function showLoginContainer() {
      loginContainer.style.display = 'flex';
      chatContainer.style.display = 'none';
    }

    // --- Inloggen ---
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      const userSnapshot = await firebase.database().ref(`users/${username}`).once('value');
      if (!userSnapshot.exists()) {
        alert('Gebruiker bestaat niet.');
        return;
      }

      const hashedPassword = CryptoJS.SHA256(password).toString();
      const userData = userSnapshot.val();

      if (userData.password !== hashedPassword) {
        alert('Onjuist wachtwoord.');
        return;
      }

      currentUser = username;
      setCookie('username', username, 7); // 7 dagen geldig
      showChatContainer();
    });

    // --- Registreren ---
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;

      const userRef = firebase.database().ref(`users/${username}`);
      const userSnapshot = await userRef.once('value');
      if (userSnapshot.exists()) {
        alert('Gebruikersnaam is al in gebruik.');
        return;
      }

      const hashedPassword = CryptoJS.SHA256(password).toString();
      await userRef.set({
        password: hashedPassword,
        createdAt: Date.now(),
        online: true
      });

      alert('Registratie gelukt! Je kunt nu inloggen.');
      registerForm.reset();
      toggleForm.click();
    });

    // --- Uitloggen ---
    logoutButton.addEventListener('click', () => {
      deleteCookie('username');
      currentUser = null;
      showLoginContainer();
    });

    // --- Chat laden ---
    async function loadGlobalChat() {
      chatMessages.innerHTML = '';
      const snapshot = await firebase.database().ref('globalMessages').limitToLast(50).once('value');
      const messages = snapshot.val() || {};
      Object.values(messages).forEach(msg => appendMessage(msg.sender, msg.text));
    }

    // --- Bericht versturen ---
    sendMessageButton.addEventListener('click', async () => {
      const text = messageInput.value.trim();
      if (!text || !currentUser) return;

      const newMsg = {
        sender: currentUser,
        text,
        timestamp: Date.now()
      };

      await firebase.database().ref('globalMessages').push(newMsg);
      messageInput.value = '';
    });

    // --- Bericht tonen ---
    function appendMessage(sender, text) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      msgDiv.innerHTML = `<b>${sender}:</b> ${text}`;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- Realtime updates ---
    firebase.database().ref('globalMessages').limitToLast(1).on('child_added', (snapshot) => {
      const msg = snapshot.val();
      appendMessage(msg.sender, msg.text);
    });

    // --- Automatisch inloggen via cookie ---
    window.addEventListener('load', () => {
      const savedUser = getCookie('username');
      if (savedUser) {
        currentUser = savedUser;
        showChatContainer();
      } else {
        showLoginContainer();
      }
    });
  </script>
</body>
</html>
